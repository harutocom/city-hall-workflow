generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model application_attachments {
  id             Int          @id @default(autoincrement())
  application_id Int
  uploaded_by_id Int
  file_name      String       @db.VarChar(255)
  file_path      String       @db.VarChar(500)
  uploaded_at    DateTime     @default(now()) @db.Timestamp(6)
  applications   applications @relation(fields: [application_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users          users        @relation(fields: [uploaded_by_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model application_templates {
  id                Int                 @id @default(autoincrement())
  name              String              @db.VarChar(255)
  description       String?
  created_by        Int?
  created_at        DateTime            @default(now()) @db.Timestamp(6)
  updated_at        DateTime            @default(now()) @db.Timestamp(6)
  deleted_at        DateTime?
  users             users?              @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  applications      applications[]
  template_elements template_elements[]
  // このテンプレートの承認ルート定義
  approval_routes  template_approval_routes[]
}

// ★新規: 承認ルート定義（テンプレート作成時に設定）
model template_approval_routes {
  id               Int      @id @default(autoincrement())
  template_id      Int
  step_order       Int      // 1, 2, 3...
  
  // Pilot版は approver_user_id を使用。将来は role_id を使用。
  approver_user_id Int?     
  approver_role_id Int?

  created_at       DateTime @default(now()) @db.Timestamp(6)
  updated_at       DateTime @default(now()) @db.Timestamp(6)

  application_templates application_templates @relation(fields: [template_id], references: [id], onDelete: Cascade)
  users                 users?                @relation(fields: [approver_user_id], references: [id])
  roles                 roles?                @relation(fields: [approver_role_id], references: [id])

  @@unique([template_id, step_order])
}

model application_values {
  id                Int               @id @default(autoincrement())
  application_id    Int
  sort_order     Int  
  value_text     String?   @db.Text
  value_number   Int?
  value_datetime DateTime? @db.Timestamp(6)
  value_boolean  Boolean?
  created_at        DateTime          @default(now()) @db.Timestamp(6)
  updated_at        DateTime          @default(now()) @db.Timestamp(6)
  applications      applications      @relation(fields: [application_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model applications {
  id                      Int                       @id @default(autoincrement())
  applicant_id            Int
  template_id             Int
  status                  String                    @db.VarChar(50)
  // ★追加: 現在の進行状況 (1, 2, 3...)
  current_step            Int      @default(1)
  submitted_at            DateTime?                 @db.Timestamp(6)
  completed_at            DateTime?                 @db.Timestamp(6)
  created_at              DateTime                  @default(now()) @db.Timestamp(6)
  updated_at              DateTime                  @default(now()) @db.Timestamp(6)
  application_attachments application_attachments[]
  application_values      application_values[]
  // ★追加: 申請ごとの承認ステップ実体
  approval_steps          application_approval_steps[]
  users                   users                     @relation(fields: [applicant_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  application_templates   application_templates     @relation(fields: [template_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  approval_flows          approval_flows[]
}

// ★新規: 承認ステップ実体（申請時にルート定義からコピーされる）
model application_approval_steps {
  id              Int          @id @default(autoincrement())
  application_id  Int
  step_order      Int          // 1, 2, 3...
  
  approver_id     Int          // 実際に承認すべきユーザー
  status          String       @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REMANDED
  
  acted_at        DateTime?    @db.Timestamp(6)
  comment         String?      @db.Text

  created_at      DateTime     @default(now()) @db.Timestamp(6)
  updated_at      DateTime     @default(now()) @db.Timestamp(6)

  applications    applications @relation(fields: [application_id], references: [id], onDelete: Cascade)
  users           users        @relation(fields: [approver_id], references: [id], onDelete: NoAction)

  @@unique([application_id, step_order])
}

model approval_flows {
  id             Int          @id @default(autoincrement())
  application_id Int
  approver_id    Int
  action         String       @db.VarChar(50)
  comment        String?
  acted_at       DateTime     @default(now()) @db.Timestamp(6)
  applications   applications @relation(fields: [application_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users          users        @relation(fields: [approver_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model departments {
  id    Int     @id @default(autoincrement())
  name  String  @unique @db.VarChar(255)
  users users[]
}

model permissions {
  id               Int                @id @default(autoincrement())
  name             String             @unique @db.VarChar(255)
  description      String?
  user_permissions user_permissions[]
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model roles {
  id    Int     @id @default(autoincrement())
  name  String  @unique @db.VarChar(255)
  users users[]
  // ★追加: このロールが割り当てられた承認ルート定義
  template_approval_routes template_approval_routes[]
}

model template_elements {
  id                    Int                   @id @default(autoincrement())
  template_id           Int
  component_name        String                @db.VarChar(255)
  sort_order            Int
  props                 Json                  @default("{}")
  data_type             String?
  application_templates application_templates @relation(fields: [template_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model user_permissions {
  user_id       Int
  permission_id Int
  granted_at    DateTime    @default(now()) @db.Timestamp(6)
  permissions   permissions @relation(fields: [permission_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users         users       @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@id([user_id, permission_id])
}

model users {
  id                      Int                       @id @default(autoincrement())
  name                    String                    @db.VarChar(255)
  email                   String                    @unique @db.VarChar(255)
  password_hash           String                    @db.VarChar(255)
  department_id           Int?
  role_id                 Int?
  remaining_leave_hours   Decimal                   @default(0) @db.Decimal
  created_at              DateTime                  @default(now()) @db.Timestamp(6)
  updated_at              DateTime                  @default(now()) @db.Timestamp(6)
  deleted_at              DateTime?                 @db.Timestamp(6)
  // ★追加: 承認関連のリレーション
  template_approval_routes   template_approval_routes[]
  application_approval_steps application_approval_steps[]
  application_attachments application_attachments[]
  application_templates   application_templates[]
  applications            applications[]
  approval_flows          approval_flows[]
  user_permissions        user_permissions[]
  departments             departments?              @relation(fields: [department_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles                   roles?                    @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}
